<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Settings - SplitEase</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Custom CSS -->
    <link href="styles.css" rel="stylesheet" />
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg"></div>
    <div class="floating-orb orb-1"></div>
    <div class="floating-orb orb-2"></div>
    <div class="floating-orb orb-3"></div>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg glass-navbar fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold gradient-text" href="index.html">
                <i class="bi bi-piggy-bank me-2"></i>SplitEase
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html"><i class="bi bi-house me-1"></i>Dashboard</a></li>
                    <!-- <li class="nav-item"><a class="nav-link" href="activity.html"><i class="bi bi-clock-history me-1"></i>Recent Activity</a></li> -->
                    <!-- <li class="nav-item"><a class="nav-link" href="friends.html"><i class="bi bi-people me-1"></i>Friends</a></li> --> 
                    <li class="nav-item"><a class="nav-link active" href="settings.html"><i class="bi bi-gear me-1"></i>Settings</a></li>
                </ul>
                <div class="d-flex align-items-center">
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i><span id="navbarUserName">User</span>
                        </button>

                        <ul class="dropdown-menu" aria-labelledby="userDropdownBtn">
                            <li><a class="dropdown-item" href="settings.html"><i class="bi bi-gear me-2"></i>Settings</a></li>
                            <li><a class="dropdown-item" href="login.html"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container py-5 mt-5 position-relative" style="z-index: 10;">
        <div class="glass-card p-4 p-md-5">
            <h1 class="display-5 fw-bold gradient-text mb-4">Account Settings</h1>

            <!-- Profile Settings -->
            <div class="mb-5">
                <h3 class="h4 fw-bold mb-3 d-flex align-items-center">
                    <div class="bg-primary rounded-pill me-3" style="width: 4px; height: 25px;"></div>
                    Profile Information
                </h3>
                <form id="profileForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">First Name</label>
                            <input type="text" name="firstName" class="form-control gradient-input" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Last Name</label>
                            <input type="text" name="lastName" class="form-control gradient-input" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Email</label>
                            <input type="email" name="email" class="form-control gradient-input" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Phone</label>
                            <input type="tel" name="phone" class="form-control gradient-input" />
                        </div>
                    </div>
                    <button type="submit" class="btn btn-gradient mt-3">
                        <i class="bi bi-check-circle me-2"></i>Update Profile
                    </button>
                </form>
            </div>

            <!-- Danger Zone -->
            <div class="mb-5">
                <h3 class="h4 fw-bold mb-3 d-flex align-items-center text-danger">
                    <div class="bg-danger rounded-pill me-3" style="width: 4px; height: 25px;"></div>
                    Danger Zone
                </h3>
                <button class="btn btn-outline-danger" id="deleteAccountBtn">
                    <i class="bi bi-trash me-2"></i>Delete Account
                </button>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    $(document).ready(function() {
        const API_BASE = 'http://localhost:4000/api';

        // Populate form on page load with user info from localStorage
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (user) {
            const names = user.name ? user.name.split(' ') : ['', ''];
            $('input[name="firstName"]').val(names[0] || '');
            $('input[name="lastName"]').val(names.slice(1).join(' ') || '');
            $('input[name="email"]').val(user.email || '');
            if(user.phone) $('input[name="phone"]').val(user.phone);
        }

        // Profile update form submission
        $('#profileForm').submit(async function(event) {
            event.preventDefault();

            const firstName = $('input[name="firstName"]').val().trim();
            const lastName = $('input[name="lastName"]').val().trim();
            const email = $('input[name="email"]').val().trim();
            const phone = $('input[name="phone"]').val().trim();

            if (!firstName || !lastName || !email) {
                alert('Please fill out all required fields.');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/users/profile`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ firstName, lastName, email, phone })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Failed to update profile');

                alert('Profile updated successfully.');

                // Update localStorage user info
                user.name = `${firstName} ${lastName}`;
                user.email = email;
                user.phone = phone;
                localStorage.setItem('user', JSON.stringify(user));

                // Optionally update navbar username dynamically here
                $('#navbarUserName').text(`${firstName} ${lastName}`);


            } catch (err) {
                alert('Error updating profile: ' + err.message);
            }
        });

        // Delete account button event
        $('#deleteAccountBtn').click(async function() {
            if (!confirm('Are you sure you want to delete your account? This cannot be undone.')) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/users`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Account deletion failed');

                alert('Account deleted successfully.');
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';

            } catch (err) {
                alert('Error deleting account: ' + err.message);
            }
        });
    });
    $(document).ready(function() {
    // Auth check - redirect to login if not logged in
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = 'login.html';
        return;
    }
    // Get user info and set name in navbar
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (user.name) {
        $('#navbarUserName').text(user.name);
    }
});

    </script>
</body>
</html>
